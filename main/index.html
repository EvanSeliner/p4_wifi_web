<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ESP32-P4 Video + Gamepad</title>
    <style>
      body { font-family: system-ui, Arial; padding: 12px; max-width: 960px; margin: 0 auto; }
      h1 { text-align: center; }
      .container { display: flex; gap: 24px; }
      .video-container { flex: 3; }
      .controls-container { flex: 2; }
      #video-player { width: 100%; background-color: #000; }
      .btn { display:flex; gap:12px; align-items:center; padding:6px 0; }
      .dot { width:12px; height:12px; border-radius:50%; background:#ccc; }
      .dot.pressed { background:#0a0; }
      .val { color:#555; font-family: monospace; }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/mbebenita/Broadway/Player/Broadway.js"></script>
  </head>
  <body>
    <h1>ESP32-P4 Video + Gamepad</h1>
    <div class="container">
      <div class="video-container" id="video-container">
        <h2>Video Stream</h2>
        <canvas id="video-player"></canvas>
      </div>
      <div class="controls-container">
        <h2>Gamepad</h2>
        <p id="status">Waiting for gamepadâ€¦</p>
        <div id="buttons"></div>
      </div>
    </div>

    <script>
      // --- Video WebSocket ---
      const videoPlayer = new Player({
        useWorker: true,
        webgl: 'auto',
        size: { width: 640, height: 480 }
      });
      document.getElementById('video-container').appendChild(videoPlayer.canvas);

      const ws = new WebSocket(`ws://${window.location.host}/ws`);
      ws.binaryType = 'arraybuffer';
      ws.onmessage = (event) => {
        // Broadway player expects a Uint8Array
        const frame = new Uint8Array(event.data);
        videoPlayer.decode(frame);
      };
      ws.onopen = () => console.log('Video WebSocket connected');
      ws.onclose = () => console.log('Video WebSocket disconnected');

      // --- Gamepad Logic ---
      const statusEl = document.getElementById("status");
      const buttonsEl = document.getElementById("buttons");

      let gpIndex = null;
      let raf = null;

      function ensureButtons(count) {
        while (buttonsEl.childElementCount < count) {
          const row = document.createElement("div");
          row.className = "btn";
          row.innerHTML = `
            <div class="dot" aria-hidden></div>
            <div>
              <div class="label"></div>
              <div class="val"></div>
            </div>
          `;
          buttonsEl.appendChild(row);
        }
        while (buttonsEl.childElementCount > count) {
          buttonsEl.removeChild(buttonsEl.lastChild);
        }
      }

      function renderButtons(buttons) {
        ensureButtons(buttons.length);
        for (let i = 0; i < buttons.length; i++) {
          const b = buttons[i];
          const row = buttonsEl.children[i];
          const dot = row.querySelector(".dot");
          const label = row.querySelector(".label");
          const val = row.querySelector(".val");

          if (b.pressed) dot.classList.add("pressed");
          else dot.classList.remove("pressed");

          label.textContent = `Button ${i}`;
          val.textContent = `pressed: ${b.pressed}  value: ${Number(b.value).toFixed(3)}`;
        }
      }

      function poll() {
        const gps = navigator.getGamepads ? navigator.getGamepads() : [];
        const g = (gpIndex != null) ? gps[gpIndex] : null;

        if (g) {
          statusEl.textContent = `Gamepad: ${g.id} (index ${g.index})`;
          renderButtons(g.buttons);
        } else {
          statusEl.textContent = "No gamepad connected";
          buttonsEl.innerHTML = "";
        }

        raf = requestAnimationFrame(poll);
      }

      window.addEventListener("gamepadconnected", (e) => {
        gpIndex = e.gamepad.index;
        console.log("connected", e.gamepad);
        if (raf == null) poll();
      });

      window.addEventListener("gamepaddisconnected", (e) => {
        if (gpIndex === e.gamepad.index) gpIndex = null;
        console.log("disconnected", e.gamepad);
      });

      window.addEventListener("load", () => {
        const gps = navigator.getGamepads ? navigator.getGamepads() : [];
        for (let i = 0; i < gps.length; i++) {
          if (gps[i]) {
            gpIndex = gps[i].index;
            break;
          }
        }
        poll();
      });
    </script>
  </body>
</html>
